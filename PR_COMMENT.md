# 柔軟な図面解析と図面タイプ判断機能の追加

## 概要

建築図面解析の柔軟性と精度を向上させるため、以下の機能を追加・改善しました：

1. **図面タイプ自動判断機能**: 寸法線がある詳細図面と面積が記載されている簡易図面を自動判別
2. **柔軟な検証ロジック**: 固定の必須部屋リストを削除し、図面から読み取れる情報に基づく検証に変更
3. **部屋面積計算ツールの追加**: 寸法から面積を計算する専用ツールを追加
4. **モデル変更**: デフォルトモデルを`gemini-3-pro-preview`に変更

## 主な変更内容

### 1. 図面タイプ判断機能 (`main.py`, `prompts/area_extract.md`)

図面を以下の2タイプに自動分類し、適切な処理を行います：

- **`detailed`**: 寸法線（mm単位）があり、面積を計算できる図面（平面詳細図、施工図など）
  - 寸法線を読み取って`calculate_room_area_from_dimensions`で面積を計算
  - 仕上表に記載されている全ての室について、必ず面積を算出
  
- **`simple`**: 面積が文字で直接記載されており、寸法線がない図面（間取り図、パンフレットなど）
  - 記載されている面積をそのまま抽出
  - 記載がない場合は空欄でも可

**実装詳細:**
- `_get_diagram_type()`: 図面タイプを取得
- `_validate_room_areas()`: 図面タイプに応じた柔軟な検証
- JSON出力に`diagram_type`フィールドを追加

### 2. 柔軟な検証ロジック (`main.py`)

固定の必須部屋リスト（`REQUIRED_ROOM_AREAS`）を削除し、以下の検証に変更：

- 計算根拠（`calculation`）があるのに`area_m2`が空欄 → 警告
- 帖数（`tatami`）があるのに`area_m2`が空欄 → 警告
- **`detailed`図面の場合のみ**: 仕上表に記載されている室で面積が空欄 → 警告
- **`simple`図面の場合**: 記載がなければ空欄でもOK

これにより、様々なタイプの図面に対応できるようになりました。

### 3. 部屋面積計算ツールの追加 (`extractors/skills.py`, `extractors/tool_definitions.py`)

Function Callingで使用する新しいツールを追加：

- **`calculate_room_area_from_dimensions`**: 寸法（mm）から部屋の面積と帖数を計算
  - 入力: `room_name`, `width_mm`, `depth_mm`, `calculation_note`
  - 出力: `area_m2`, `tatami`, `calculation`（計算式）
  
- **`calculate_composite_area`**: 複数の矩形領域を加算・減算して面積を計算
  - 複合形状の部屋に対応
  - 各ステップの計算過程を記録

### 4. モデル変更 (`main.py`, `Makefile`)

デフォルトモデルを`gemini-3-flash-preview`から`gemini-3-pro-preview`に変更。

## 変更ファイル

- `main.py`: 検証ロジックと図面タイプ判断機能の実装（+161行）
- `prompts/area_extract.md`: 図面タイプ判断の指示を追加（+37行）
- `extractors/skills.py`: 部屋面積計算関数を追加（+59行）
- `extractors/tool_definitions.py`: Function Calling用の関数宣言を追加（+46行）
- `Makefile`: デフォルトモデル名を更新

## 動作の変更点

### Before
- 固定の必須部屋リスト（玄関、廊下、キッチン、洗面室、便所、WIC）をチェック
- 必須部屋が欠落しているとエラー
- 全ての図面で同じ検証ロジックを適用

### After
- 図面タイプを自動判断
- `detailed`図面: 寸法線を読み取って面積を計算（必須）
- `simple`図面: 記載されている面積を抽出（記載がなければ空欄OK）
- より柔軟で実用的な検証

## テスト推奨事項

1. **詳細図面（`detailed`）**: 寸法線がある平面詳細図で、全ての部屋の面積が正しく計算されることを確認
2. **簡易図面（`simple`）**: 面積が記載されている間取り図で、記載値が正しく抽出されることを確認
3. **混合ケース**: 一部の部屋にしか寸法線がない図面での動作確認

## 関連Issue

- 図面タイプによって処理を分ける必要がある
- 固定の必須部屋リストでは柔軟性が不足していた
- 様々なタイプのPDF図面に対応したい
