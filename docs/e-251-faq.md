# E-251 FAQ（実装準拠）

このFAQは、`extractors/e251_extractor.py` と関連テスト（`tests/test_e251_extractor.py`）に基づいて記載しています。  
推測ではなく、現在コードで実際に行っている処理だけを対象にしています。

---

## 1. 抽出対象の認識

### Q. どこを「E-251の対象領域」として読んでいますか？
A. まずOCR単語群から `住戸内` と `照明器具姿図` を同時に含むタイトル行を探します（`_is_section_title`）。  
そのタイトル行を起点に、帯領域（`x_min` 以右、`title_y-20` から `title_y+520`）へ絞って解析します（`_extract_section_words`）。

### Q. ページ全体を読むのではないのですか？
A. OCR自体はページ全体に対して実行しますが、候補抽出はタイトル帯に絞った `section_words` に対して行います。  
これにより、同一ページ内の他表・注記の混入を抑えます。

---

## 2. 器具記号の認識

### Q. 器具記号はどう認識していますか？
A. 2段階です。

1. 行内に `器具記号:メーカー 型番` がある場合は、その行から直接抽出（`_extract_candidates_from_cluster`）
2. 行内に器具記号がない場合は、枠上部の記号アンカーを最寄りXで割当（`_detect_anchors` + `_assign_equipment_from_anchors`）

### Q. `D1` が `D` と `1` に分かれてOCRされた場合は？
A. `_detect_anchors` で隣接トークンを結合して `D1` として扱います（ギャップ20px以内）。

### Q. `D1` / `L1` は保持されますか？
A. はい。`_is_equipment_code`（`^[A-Z]\d{1,2}$`）に一致するため保持されます。  
`build_output_rows` でも `器具記号` として出力されます。

### Q. 丸Hのような記号はどうなりますか？
A. 単独英字は `_is_symbol_like` で「記号扱い」と判定し、`器具記号=""` にします。  
アンカー割当時も有効コードでないため空欄のままです。

### Q. `L1(L1500)` のような括弧付きは保持されますか？
A. はい。`_normalize_equipment_label` が `L1( ... )` 形式を正規化して保持します。  
`L1(L1500)` の形式はテストでも保証されています。

---

## 3. メーカー・相当型番の認識

### Q. どの書式を読めますか？
A. 現実装で対応しているのは次の3パターンです。

1. `器具記号(...) : メーカー 型番`（`EQ_COLON_MAKER_MODEL_PATTERN`）
2. `メーカー:型番`（`MAKER_COLON_MODEL_PATTERN`）
3. `メーカー 型番`（`MAKER_SPACE_MODEL_PATTERN`）

### Q. ノイズはどう弾いていますか？
A. メーカーは `_is_likely_maker`、型番は `_is_likely_model` で最低限のフィルタを掛けています。  
たとえば、ワット数だけの文字列（`LED0.5W` 等）や配線系トークン（`PF*`, `VVF*`, `SCV*`）は型番候補から除外します。

### Q. 同じ行で重複抽出されませんか？
A. `occupied_spans` と `seen` キーで重複を抑止します。  
先に高優先パターン（器具記号付き）を取り、その文字範囲に重なる後続マッチを除外します。

---

## 4. 枠の混在防止と並び順

### Q. 枠Aの情報が隣枠Bへ混ざらない仕組みは？
A. 完全な罫線トレースではなく、次の近似分離です。

1. タイトル帯で対象セクションを限定（`_extract_section_words`）
2. 器具記号がない行は「最寄りXのアンカー」を割当（`_assign_equipment_from_anchors`）
3. 候補行の `row_x` をクラスタ化して `block_index` を付与（`_assign_block_indexes`）

この組み合わせで、左枠/右枠の混在を抑えています。

### Q. 出力順はどう決まりますか？
A. `build_output_rows` で次のキー順にソートしています。

1. `page`
2. `block_index`（左から右）
3. `row_y`（上から下）
4. `row_x`

つまり、人の読み順（左ブロックを先に処理）を優先する実装です。

---

## 5. 除外・出力条件

### Q. どんな行を出力しませんか？
A. 主に次です。

- 注記行（`型番は相当品とする` を含む行、`注記` 行）
- `メーカー` と `相当型番` が両方空の行（`build_output_rows` で除外）

### Q. CSVの列と文字コードは？
A. 列は固定で `器具記号, メーカー, 相当型番`。  
文字コードは `utf-8-sig`（UTF-8 with BOM）です（`write_csv`）。

---

## 6. 実行条件・API

### Q. 必須の環境変数は？
A. `VISION_SERVICE_ACCOUNT_KEY` が必須です。未設定時は `/e-251/upload` がエラーになります。

### Q. APIは何ですか？
A. E-251関連は次の3つです（`main.py`）。

- `GET /e-251`
- `POST /e-251/upload`
- `GET /jobs/{job_id}/e251.csv`

---

## 7. 制約

### Q. どんな場合に調整が必要ですか？
A. 次の条件では閾値や正規表現調整が必要になる可能性があります。

- タイトル位置や構成が大きく異なるレイアウト
- 英字メーカー前提を外れる表記
- 器具記号形式が `^[A-Z]\d{1,2}` から外れるケース

現実装は E-251 形式に最適化したヒューリスティック抽出です。
