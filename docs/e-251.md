# E-251 住戸内照明器具姿図抽出 機能ドキュメント

**E-251 OCR** は、`E-251` などの住戸内照明器具姿図PDFから、
`器具記号 / メーカー / 相当型番` の3列を抽出してCSV出力する機能です。

---

## 何ができるか

| 入力 | 出力 |
|---|---|
| 住戸内照明器具姿図PDF（例: E-251） | 3列テーブル（HTML） |
| 同上 | `e251.csv`（ダウンロード） |

---

## 出力列

1. `器具記号`
2. `メーカー`
3. `相当型番`

CSV文字コードは `UTF-8 with BOM (utf-8-sig)` です。

---

## 抽出ルール

1. `D1`, `D2`, `L1〜L5` のような英数字コードは器具記号として保持します。
2. 丸記号などの非英数字記号（例: 丸H）は `器具記号=""` として出力します。
3. 次の表記形式を読み取ります。
- `メーカー:型番`（例: `DNL:D-EX12`）
- `メーカー 型番`（例: `DAIKO LZD-93195XW`）
- `器具記号(...) : メーカー 型番`（例: `L2(L1200):DAIKO DSY-4393YWG`）
4. `L1〜L5` の列挙は個別行で出力します。
5. 完全空枠（メーカー・相当型番とも空）は出力しません。

---

## API

| Method | Path | 説明 |
|---|---|---|
| `GET` | `/e-251` | E-251抽出画面 |
| `POST` | `/e-251/upload` | PDFを受け取り抽出してHTMLを返す |
| `GET` | `/jobs/{job_id}/e251.csv` | 実行結果のCSVをダウンロード |

---

## 実装ファイル

- ルーティング: `main.py`
- 抽出ロジック: `extractors/e251_extractor.py`
- ジョブCSV種別: `extractors/job_store.py`
- UIテンプレート: `templates/e-251.html`
- テスト: `tests/test_e251_extractor.py`, `tests/test_integration_routes.py`, `tests/test_job_store.py`

---

## 必要な設定

- `VISION_SERVICE_ACCOUNT_KEY`（Google Vision APIサービスアカウントJSON）

未設定時は `/e-251/upload` がエラーを返します。

---

## 注意点

- OCR特性上、図面品質や文字の潰れにより誤読が発生する場合があります。
- 複数ページPDFは全ページを対象に処理します。

---

## 関連ドキュメント

- 詳細設計: `docs/e-251-detail.md`
- FAQ（実装準拠）: `docs/e-251-faq.md`
