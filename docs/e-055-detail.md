# E-055 抽出機能 詳細設計（開発者向け）

このドキュメントは `E-055` の抽出ロジックを、実装の背景と意図を含めて説明する開発者向け資料です。  
対象実装: `extractors/e055_extractor.py`

---

## 1. 目的と前提

`E-055` 系の照明器具姿図から、以下3列を抽出します。

1. `器具記号`
2. `メーカー`
3. `相当型番`

E-055 は図面内の表記揺れが大きく、単純な行抽出では不足します。実装は次の現実課題を解くための構成です。

- `器具記号` が行頭にある通常行と、器具記号なし継続行が混在する
- `メーカー:型番` 形式と、型番のみ形式、`同上` 系表記が混在する
- OCR誤読（ダッシュ種別、ガード付の誤読、分割トークン）が起こる
- 非常灯評定番号や不要行を除外する必要がある
- 出力順は人が読む順（ページ→セクション→左ブロック→右ブロック→上から下）に揃えたい

---

## 2. 全体アーキテクチャ

エントリポイントは `extract_e055_pdf()` です。

1. Visionクライアント構築
2. PDFページ数解決（全ページまたは指定ページ）
3. `pdftoppm` でページ画像化
4. Vision OCR（word単位 + bbox）取得
5. Yクラスタで行化
6. ヘッダ行（`器具記号` + `相当型番`）を起点にセクション分割
7. 各行から候補抽出
8. ブロック推定と継続行の器具記号伝播
9. `メーカー/型番` 分解と不要行フィルタ
10. ソートしてCSV出力（UTF-8 BOM）

---

## 3. データモデル

主な内部データ構造:

- `WordBox(text, cx, cy, bbox)`
- `RowCluster(row_y, words)`
- 候補行dict（主キー）
  - `page`, `section_index`, `block_index`, `row_y`, `row_x`, `model_x`
  - `機器器具`, `相当型番`

出力時は以下に正規化されます。

- `機器器具` → `器具記号`
- `相当型番` を `split_equivalent_model()` で `メーカー` / `型番` に分解

---

## 4. 実装の核心と採用理由

### 4.1 ヘッダ起点のセクション抽出

`_is_header_row()` は `相当型番` と `器具記` の同時出現でヘッダ判定します。  
`_extract_page_candidate_rows()` はヘッダ区間ごとにセクションを切ります。

理由:

- E-055 は1ページ内に複数帯があり、全行一括で処理すると器具記号の文脈が壊れる
- セクション単位にすることで、継続行の器具記号補完を局所化できる

### 4.2 行内複数候補の抽出

`_extract_candidates_from_cluster()` は、1行の中に複数器具が並ぶケースを想定し、`code_indexes` で分割抽出します。

分岐:

1. 器具記号トークンあり
- `器具記号` から次の `器具記号` 手前までを1セグメントとして解析
- `メーカー:型番` か、型番のみか、`同上` 系かを判断

2. 器具記号トークンなし
- `メーカー:型番` の継続行を抽出（`_extract_colon_model_only_candidates`）
- それでも取れない場合、W値を含む型番行を抽出（`_extract_model_only_candidates`）

理由:

- 継続行は器具記号を持たないため、行種別で抽出ルールを分ける必要がある
- `DAIKO:LZA-93039` のような継続行を落とさないため、コロン系はW値ガードを外している

### 4.3 `model_x` を持つ理由

候補には `row_x` だけでなく `model_x` を保持します。

- `row_x`: 器具記号列の位置
- `model_x`: 型番列の位置

`_propagate_equipment_in_section()` で継続行を器具記号へ紐づけるとき、`model_x` の近さを使って対応付けます。

理由:

- 継続行は器具記号列が空欄でも、型番列のX位置でどの器具に属するか判定できる
- 同じY帯に複数継続行がある場合、左から順の単純対応だけでは誤配賦が起きる

### 4.4 継続行の2段階伝播

`_propagate_equipment_in_section()` は次の2段階で伝播します。

1. Y方向の最近傍行からの補完
- 直前の器具記号あり行を探索（距離120px以内）
- 行数一致なら左から順に割当
- 不一致なら `model_x` 最近傍で割当

2. ブロック内の前行引継ぎ
- 同一 `block_index` で上から順に走査し、直前器具記号を空欄行へ引継ぐ

理由:

- 1段階だけでは TP系・DL系の混在レイアウトで取りこぼしや誤割当が出る
- 2段階にすることで「表の構造」と「局所連続性」の両方を利用できる

### 4.5 ブロック推定による読み順維持

`_cluster_x_positions()` で `row_x` をクラスタ化し `block_index` を付与。  
`build_output_rows()` は次でソートします。

1. `page`
2. `section_index`
3. `block_index`（左→右）
4. `row_y`（上→下）
5. `row_x`

理由:

- OCR順は読み順と一致しないため、明示的な並び替えが必要
- E-055の利用者が期待する自然順に一致させるため

### 4.6 線認識サブ信号（低信頼時のみ）

既存ロジックの上に、**低信頼ケース限定**で線認識を補助的に実行します。  
実装は `_extract_page_candidate_rows()` 内で以下順です。

1. 既存ロジックで `section_candidates` と初期 `block_index` を作る
2. `_should_run_line_assist(...)` で低信頼判定（`auto`時）
3. 必要時のみ `_apply_line_assist_if_confident(...)` を実行
4. 信頼度が閾値以上かつ品質改善がある場合のみ `block_index` を置換
5. 既存 `_propagate_equipment_in_section()` を実行

線認識ソース:

- vector線: `_collect_vector_vertical_lines(...)`（pdfplumber）
- image線: `_collect_image_vertical_lines(...)`（OpenCV Hough）
- 統合: `_merge_vertical_lines(...)` + `_build_line_based_blocks(...)`

採用判定:

- `_line_assist_confidence(...) >= E055_LINE_ASSIST_MIN_CONFIDENCE`
- かつ、以下のいずれかが改善
  - 継続行の未解決件数
  - `model_x` と block 整合の平均距離

このため、線認識が不安定でも既存結果へ保守的にフォールバックします。

---

## 5. 正規化とフィルタの仕様

### 5.1 型番正規化

`_cleanup_model_text()` で以下を正規化します。

- ダッシュ揺れ統一
- ハイフン周り空白整理
- 多重空白除去
- 句点以降のノイズ切り捨て

`_append_multiplier_suffix()` は `×2`, `x3`, `(x2)` などを保持します。

### 5.2 `同上` 系正規化

`_normalize_doujou_model()`:

- `同上` を検知
- ガード付OCR揺れ（`犬-F`, `一卡付`, `力ー...付` など）を `同上ガード付` に統一

### 5.3 `メーカー/型番` 分解

`split_equivalent_model()`:

- `メーカー:型番` / `メーカー：型番` を分解
- コロンなしは `メーカー=""`, `型番=<元値>`

### 5.4 除外ルール

`_should_skip_output_row()` で以下を除外します。

- 型番空
- `機器器具` が `EDL/EDM/ECL/ECM/ECH/ES1/ES2`
- 型番が `LALE-*`（非常灯評定番号）

理由:

- 仕様上不要な評定番号・空実体の排除

---

## 6. 診断（Debug）機構

`E055_DEBUG_DIAGNOSTICS=1` で診断JSONを書き出します。

出力先:

- `/tmp/plan2table/debug/<job_id>/e055_diagnostics.json`

含まれる情報:

- 実行環境（git sha, vision/pillow/pdftoppm）
- ページ別OCRクラスタ統計
- フォーカス行トークン（bbox付き）
- 抽出候補（`機器器具`, `相当型番`, `block_index`, `model_x`）

関連環境変数:

- `E055_DEBUG_FOCUS_TERMS`
- `E055_DEBUG_FOCUS_ROW_LIMIT`
- `E055_DEBUG_CANDIDATE_LIMIT`
- `E055_DEBUG_LOG_SUMMARY`
- `E055_DEBUG_LOG_ROW_LIMIT`
- `E055_DEBUG_LOG_CANDIDATE_LIMIT`
- `E055_LINE_ASSIST_DEBUG`

採用理由:

- OCRは再現が難しい不具合が多く、候補生成のトレースが必須
- PRレビュー時に「どの段で落ちたか」を可視化できる

---

## 7. 柔軟性（吸収できる揺れ）

対応可能な揺れ:

- 全角/半角コロン
- ダッシュ種別
- 乗数表記（`×`, `x`, `✕`, `(xN)`）
- `同上ガード付` の誤読
- 継続行（器具記号空欄）の補完
- 同一行複数候補の抽出

主な調整ノブ:

- `y_cluster`（既定18.0）
- Xクラスタ許容幅（既定220.0）
- 継続行のY距離許容（120.0）
- `E055_LINE_ASSIST_MODE`（`auto/off/force`）
- `E055_LINE_ASSIST_LATENCY_BUDGET_MS`（既定300ms）
- `E055_LINE_ASSIST_MIN_CONFIDENCE`（既定0.70）

---

## 8. 制約と既知リスク

1. ヘッダ語依存
- `器具記号` と `相当型番` の語がOCRで大きく崩れるとセクション検出失敗の可能性がある

2. 記号体系依存
- `_is_equipment_code_token()` の許可プレフィクスにない新記号は抽出漏れする

3. 完全一般化ではない
- E-055系レイアウト最適化であり、他図面への横展開には閾値・ルール調整が前提

4. ルール競合の余地
- 同一行に配線系文字列と型番が密集すると、稀に誤候補生成が起こりうる

5. 線認識依存の追加リスク
- OpenCV未導入環境では image線は無効（vector線または既存経路へフォールバック）
- スキャン品質が悪い場合、線認識は採用されず既存ロジックに戻る設計

---

## 9. 拡張ガイド

### 9.1 新しい器具記号プレフィクスを追加

- `_is_equipment_code_token()` の `allowed_prefixes` を更新
- テスト追加: `tests/test_e055_extractor.py`

### 9.2 継続行誤配賦を改善

- `model_x` ベース割当ロジックを優先度調整
- Y許容値（120px）とXクラスタ幅（220px）を図面単位でチューニング

### 9.3 ノイズ除外を強化

- `_is_likely_model` 相当ロジックはE-055では分散しているため、
  `MODEL_PATTERN` と `_cleanup_model_text()` 側で段階的に強化する

---

## 10. テスト戦略

主要テスト:

- `tests/test_e055_extractor.py`
  - 分解ロジック
  - 継続行補完
  - 並び順
  - 同上正規化
  - 除外ルール

- `tests/test_integration_routes.py`
  - `/e-055/upload` 正常系・異常系
  - `/jobs/{job_id}/e055.csv` ダウンロード

推奨運用:

1. ロジック変更時は `python3 -m pytest -q` をフル実行
2. 挙動差分調査時は `E055_DEBUG_DIAGNOSTICS=1` を有効化
3. 実図面でCSVを目視比較し、読み順と継続行配賦を優先確認

---

## 11. 運用上の基準

E-055機能は「抽出精度だけ」でなく、以下3点を同時に満たしているかで評価します。

1. 取りこぼしがない（継続行含む）
2. 不要行を出さない（評定番号・空行）
3. 人が読む順で並ぶ（セクション/ブロック/行順）

この3点を崩す変更は、テスト追加と診断ログで根拠を明示してから導入してください。

---

## 12. 線認識サブ信号の実測結果（2026-02-25）

対象:

- 実データ: `E-055.pdf`（1ページ）
- 比較条件:
  - `E055_LINE_ASSIST_MODE=auto`
  - `E055_LINE_ASSIST_MODE=force`

結果サマリ:

- `auto`: 30行、`invoked=0`、`adopted=0`
- `force`: 30行、`invoked=5`、`adopted=0`
- `force` 側の主な不採用理由: `no_quality_gain`
- 出力CSVは `auto` / `force` で完全一致

解釈:

- 既存OCR座標ロジックだけで十分安定しているページでは、線認識を使っても品質改善が出ない。
- そのため、常時ONは不要だが「低信頼ケースだけ使う保険」として残す価値がある。

運用方針:

1. 既定は `auto` のまま維持
2. 誤紐付けが疑われる案件のみ `force` で診断
3. 長期運用で有効事例がなければ削除可否を再評価
