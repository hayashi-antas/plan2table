# E-142 FAQ（実装準拠）

このFAQは、`extractors/e142_extractor.py`・`main.py`・関連テストに基づいて記載しています。  
推測ではなく、現在コードで実際に行っている挙動のみを対象にしています。

---

## 1. 出力形式

### Q. CSVのヘッダーはありますか？
A. ありません。`e142.csv` はヘッダーなしです。

### Q. 列数は固定ですか？
A. 固定ではありません。枠ごとに可変です。

### Q. 1行の基本構造は？
A. 次です。  
`タイトル,番号,ラベル1,値1,ラベル2,値2,...`

---

## 2. タイトル・番号の扱い

### Q. 1列目には何が入りますか？
A. 各大枠のタイトルです。タイトル候補は日本語主体のセグメントから選ばれます。

### Q. 左上の記号セルはタイトルになりますか？
A. なりません。`_is_title_candidate()` で除外する条件を入れています。

### Q. 番号は何を拾いますか？
A. 次の優先順です。

1. `MC-N0190` のような型番
2. `(商品コード:4361000)` のような括弧付き商品コード
3. `商品コード:4361000`
4. `特注品`

### Q. `2方向アダプター` の番号欄にある `特注品` は取れますか？
A. はい。特殊識別子として明示的にサポートしています。

### Q. `ロビーインターホン用埋込ボックス` の `(商品コード:4361000)` は括弧付きで出ますか？
A. はい。括弧付きのまま出力されます。

---

## 3. 表あり/表なしの挙動

### Q. 表がある枠はどう出ますか？
A. 表ラベルと値をフラット化して同じ行へ並べます。

### Q. 表がない枠は？
A. `タイトル,番号` を出力します。

### Q. 表も番号もない枠は？
A. `タイトル` のみ出力します。

---

## 4. 並び順

### Q. 出力順はどう決まりますか？
A. 読み順を次で近似しています。

1. ページ
2. 上下バンド（近いYを同一段として扱う）
3. 段内は左から右

実運用上は「左上から右、次段へ」の順になります。

---

## 5. 抽出対象と除外

### Q. 中央の図面寸法値（120, 297 など）は拾われますか？
A. 通常は拾いません。表ラベル語を含まないため表候補にならず、タイトル/番号条件にも合いにくい設計です。

### Q. 表ラベルは何を見ていますか？
A. `電源電圧, 入力電圧, 出力電圧, 出力電流, 消費電流, 消費電力, 質量, 材質, 形状, 色調, 塗色, 塗装, 備考` です。

### Q. ラベル語がない表は必ず落ちますか？
A. いいえ。ラベル語ベースで拾えない場合は、左列と右列の位置関係（同一行のラベル候補+値候補）から表行を推定するフォールバックがあります。

### Q. `塗装, 黒電着塗装` が欠落することはありますか？
A. OCR揺れ `黑` は `黒` に正規化しています。`塗装` ラベルも対象語に含めています。

---

## 6. API / UI

### Q. エンドポイントは？
A. 次の3つです。

- `GET /e-142`
- `POST /e-142/upload`
- `GET /jobs/{job_id}/e142.csv`

### Q. HTML結果は表ですか？
A. いいえ。CSV各行を `csv.writer` 相当の1行テキスト（必要時はクオート付き）として `<ol><li>` で表示します。

### Q. ダウンロード先は固定ですか？
A. はい。`/jobs/{job_id}/e142.csv` 固定です。

---

## 7. エラー時の挙動

### Q. `VISION_SERVICE_ACCOUNT_KEY` が未設定だとどうなりますか？
A. `/e-142/upload` は `data-status="error"` のHTMLを返し、`VISION_SERVICE_ACCOUNT_KEY is not configured.` を表示します。

### Q. PDF以外を送ると？
A. `Please upload a valid PDF file.` のエラーHTMLを返します。

---

## 8. 調整の入口（開発者向け）

### Q. タイトル分割がうまくいかない場合はどこを見ますか？
A. `TITLE_SEGMENT_X_GAP` と `_split_title_text_by_blocks()` / `_snap_split_boundary()` を確認します。

### Q. 番号が拾えない場合は？
A. `_pick_code_for_title()` のスコア計算と `CODE_ASSIGN_MAX_SCORE` / `PRODUCT_CODE_ASSIGN_MAX_SCORE` を確認します。

### Q. 外れ大枠が混ざる場合は？
A. `_filter_extreme_wide_blocks()` の `TABLE_MAX_WIDTH_RATIO` を確認します。

### Q. 読み順が崩れる場合は？
A. `_sort_frame_rows_in_reading_order()` の `READING_ORDER_Y_BAND` を確認します。

---

## 9. テストと確認

### Q. 最低限どのテストを回せばいいですか？
A. まず `tests/test_e142_extractor.py`、次に `tests/test_integration_routes.py` と `tests/test_job_store.py` です。

### Q. 実PDFでの確認はどうしますか？
A. `extract_e142_pdf()` を直接実行して `/tmp` にCSV出力し、期待行（タイトル先頭、32行など）を比較してください。

---

## 10. 関連資料

- 概要: `docs/e-142.md`
- 詳細: `docs/e142-detail.md`
- 実装: `extractors/e142_extractor.py`
