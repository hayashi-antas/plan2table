# E-055 FAQ（運用・開発 Q&A）

`E-055` 抽出機能で実際によく出る質問を、運用者/開発者向けにまとめたFAQです。  
対象機能: `/e-055`, `extractors/e055_extractor.py`

---

## 1. 抽出件数・読み取り範囲

### Q. 5行、10行のように複数行があっても読み取れますか？
A. はい。固定の「行数上限」はありません。OCR結果から候補を作り、条件に合う行を出力します。

### Q. 行が出力されないのはどんなときですか？
A. 主に次です。

- `型番` が空
- 非常灯評定番号など除外条件に該当
- OCR崩れでヘッダ/型番が認識できない
- ノイズと判定された

### Q. 複数ページPDFは対応していますか？
A. はい。`page <= 0` 指定時は全ページを処理します。

---

## 2. 出力順・行の扱い

### Q. 並び順はどう決まりますか？
A. 次の順です。

1. ページ
2. セクション（ヘッダ帯）
3. ブロック（左→右）
4. 行（上→下）

### Q. 1つの器具記号に継続行がある場合は？
A. 継続行（器具記号空欄）を直前行・近傍列へ伝播して紐づけます。

### Q. 重複行は削除されますか？
A. いいえ。抽出順を保持します（重複排除はしません）。

---

## 3. メーカー・型番の分解

### Q. `メーカー:型番` と `メーカー：型番` は両方対応していますか？
A. はい。半角/全角コロンの両方を分解対象にしています。

### Q. コロンがない場合はどうなりますか？
A. `メーカー=""`、`型番=<抽出値>` で出力します。

### Q. `×2` や `(x3)` は残りますか？
A. はい。乗数表記は型番に保持されます。

---

## 4. 除外ルール

### Q. 非常灯関連の行はどう処理されますか？
A. 以下は出力除外です。

- 器具記号が `EDL/EDM/ECL/ECM/ECH/ES1/ES2`
- 型番が `LALE-*`（非常灯評定番号）

### Q. `同上` はどう出ますか？
A. `同上` は抽出対象です。ガード付の揺れ語を含む場合は `同上ガード付` に正規化します。

---

## 5. 精度・制約

### Q. どんなケースで精度が落ちますか？
A. 主に次です。

- 文字潰れ・低解像度
- ヘッダ文字の欠落（`器具記号` / `相当型番`）
- 極端なレイアウト差分

### Q. E-055以外の図面にそのまま使えますか？
A. 一部は可能ですが、E-055最適化です。記号体系やレイアウトが違う場合は調整が必要です。

---

## 6. 調整ポイント（開発者向け）

### Q. 行分割が荒い/細かすぎるときは？
A. `y_cluster`（既定 `18.0`）を調整します。

### Q. ブロック分けがずれるときは？
A. `_cluster_x_positions(... tolerance=220.0)` の閾値を調整します。

### Q. 継続行の誤紐付けがあるときは？
A. 次を確認します。

- `model_x` の算出位置
- 継続行許容Y距離（`120.0`）
- 直前行選択ロジック

---

## 7. デバッグ

### Q. 何を有効化すると追跡しやすいですか？
A. `E055_DEBUG_DIAGNOSTICS=1` を有効化してください。

### Q. 診断ファイルはどこに出ますか？
A. `/tmp/plan2table/debug/<job_id>/e055_diagnostics.json` に出力されます。

### Q. どの情報が見られますか？
A. 次が見られます。

- OCR行トークン（bbox付き）
- 候補行（器具記号/相当型番/座標）
- 実行環境情報（git sha, pdftoppm版, ライブラリ版）

---

## 8. 線認識サブ信号

### Q. 「枠Aの情報が隣の枠Bに混ざらない仕組み」は何ですか？
A. 現在の主ロジックは、罫線そのものを主信号として直接トレースしているわけではありません。`E-055` では次の「位置ベースの疑似枠」で分離しています。

1. ヘッダでセクションを切る  
`_is_header_row` と `_extract_page_candidate_rows` で、まず対象の表セクションを切り出し、他領域の語を混ぜないようにします。

2. X座標でブロック（枠相当）を作る  
`_cluster_x_positions` で左→右の列クラスタを作り、各候補に `block_index` を付与します。  
この `block_index` が「どの枠に属するか」の基本キーです。

3. 継続行の引き継ぎに制約をかける  
`_propagate_equipment_in_section` で器具記号空欄行を補完するとき、以下の制約で誤混入を抑制します。
- 同一セクション内のみ
- 近いY距離（120px以内）
- `model_x` 最近傍
- 同一 `block_index` 優先

4. 行内分解で混在を減らす  
`_extract_candidates_from_cluster` で1行内の複数候補を器具記号単位で分割し、1候補に不要語が巻き込まれにくいようにします。

要するに、**「セクション境界 + Xクラスタ + 距離制約」で枠を近似再構成して分離**しています。  
線認識は補助信号であり、主ロジックの分離が不安定なケースだけを補強します。

### Q. それでも線認識を実装した理由は何ですか？
A. 主ロジックだけでも多くの図面で安定しますが、次の低信頼ケースでは `block_index` の割当が揺れやすいためです。

- 継続行（器具記号空欄）比率が高い
- X中心が密集して列境界が曖昧
- `model_x` が隣ブロックへ跨ぎやすい配置

このときだけ、線認識（vector線 + image線）で列境界の補助信号を得て、品質改善が確認できた場合のみ保守的に採用する設計にしています。

### Q. 線認識は常に動きますか？
A. 既定では `E055_LINE_ASSIST_MODE=auto` のため、低信頼ケースでのみ動きます。通常ケースでは既存経路のみです。

### Q. 重くなりますか？
A. `auto` では通常ほぼ影響なしです。線認識が起動したケースのみ追加コストが発生し、`E055_LINE_ASSIST_LATENCY_BUDGET_MS`（既定300ms）で上限管理します。

### Q. 線認識結果は必ず採用されますか？
A. いいえ。`E055_LINE_ASSIST_MIN_CONFIDENCE` を満たし、かつ品質改善がある場合だけ採用します。改善がなければ既存結果にフォールバックします。

### Q. 今回の実測では `auto` でも `force` でも結果が同じでした。不要では？
A. 既定運用を `auto` にしておけば通常時コストはほぼゼロなので、保険として残す価値があります。難ケースでのみ使える補助経路として維持する方針が実務的です。

### Q. どんなときに線認識を使うべきですか？
A. 継続行の誤紐付けやブロック跨ぎが疑われるケースです。通常は `auto` で運用し、調査時だけ `force` を使って診断してください。

---

## 9. 運用時チェックリスト

### Q. 障害調査の最短手順は？
A. 次の順で実施してください。

1. 入力PDFの該当行が読める解像度か確認
2. CSVで欠落/誤割当の行を特定
3. `E055_DEBUG_DIAGNOSTICS=1` で再実行
4. `e055_diagnostics.json` の `candidate_rows` を確認
5. 必要に応じて閾値・パターンを調整

---

## 10. 関連ドキュメント

- 仕様概要: `docs/e-055.md`
- 詳細設計: `docs/e-055-detail.md`
- テスト: `tests/test_e055_extractor.py`, `tests/test_integration_routes.py`
