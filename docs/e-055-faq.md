# E-055 FAQ（運用・開発 Q&A）

`E-055` 抽出機能で実際によく出る質問を、運用者/開発者向けにまとめたFAQです。  
対象機能: `/e-055`, `extractors/e055_extractor.py`

---

## 1. 抽出件数・読み取り範囲

### Q. 5行、10行のように複数行があっても読み取れますか？
A. はい。固定の「行数上限」はありません。OCR結果から候補を作り、条件に合う行を出力します。

### Q. 行が出力されないのはどんなときですか？
A. 主に次です。

- `型番` が空
- 非常灯評定番号など除外条件に該当
- OCR崩れでヘッダ/型番が認識できない
- ノイズと判定された

### Q. 複数ページPDFは対応していますか？
A. はい。`page <= 0` 指定時は全ページを処理します。

---

## 2. 出力順・行の扱い

### Q. 並び順はどう決まりますか？
A. 次の順です。

1. ページ
2. セクション（ヘッダ帯）
3. ブロック（左→右）
4. 行（上→下）

### Q. 1つの器具記号に継続行がある場合は？
A. 継続行（器具記号空欄）を直前行・近傍列へ伝播して紐づけます。

### Q. 重複行は削除されますか？
A. いいえ。抽出順を保持します（重複排除はしません）。

---

## 3. メーカー・型番の分解

### Q. `メーカー:型番` と `メーカー：型番` は両方対応していますか？
A. はい。半角/全角コロンの両方を分解対象にしています。

### Q. コロンがない場合はどうなりますか？
A. `メーカー=""`、`型番=<抽出値>` で出力します。

### Q. `×2` や `(x3)` は残りますか？
A. はい。乗数表記は型番に保持されます。

---

## 4. 除外ルール

### Q. 非常灯関連の行はどう処理されますか？
A. 以下は出力除外です。

- 器具記号が `EDL/EDM/ECL/ECM/ECH/ES1/ES2`
- 型番が `LALE-*`（非常灯評定番号）

### Q. `同上` はどう出ますか？
A. `同上` は抽出対象です。ガード付の揺れ語を含む場合は `同上ガード付` に正規化します。

---

## 5. 精度・制約

### Q. どんなケースで精度が落ちますか？
A. 主に次です。

- 文字潰れ・低解像度
- ヘッダ文字の欠落（`器具記号` / `相当型番`）
- 極端なレイアウト差分

### Q. E-055以外の図面にそのまま使えますか？
A. 一部は可能ですが、E-055最適化です。記号体系やレイアウトが違う場合は調整が必要です。

---

## 6. 調整ポイント（開発者向け）

### Q. 行分割が荒い/細かすぎるときは？
A. `y_cluster`（既定 `18.0`）を調整します。

### Q. ブロック分けがずれるときは？
A. `_cluster_x_positions(... tolerance=220.0)` の閾値を調整します。

### Q. 継続行の誤紐付けがあるときは？
A. 次を確認します。

- `model_x` の算出位置
- 継続行許容Y距離（`120.0`）
- 直前行選択ロジック

---

## 7. デバッグ

### Q. 何を有効化すると追跡しやすいですか？
A. `E055_DEBUG_DIAGNOSTICS=1` を有効化してください。

### Q. 診断ファイルはどこに出ますか？
A. `/tmp/plan2table/debug/<job_id>/e055_diagnostics.json` に出力されます。

### Q. どの情報が見られますか？
A. 次が見られます。

- OCR行トークン（bbox付き）
- 候補行（器具記号/相当型番/座標）
- 実行環境情報（git sha, pdftoppm版, ライブラリ版）

---

## 8. 運用時チェックリスト

### Q. 障害調査の最短手順は？
A. 次の順で実施してください。

1. 入力PDFの該当行が読める解像度か確認
2. CSVで欠落/誤割当の行を特定
3. `E055_DEBUG_DIAGNOSTICS=1` で再実行
4. `e055_diagnostics.json` の `candidate_rows` を確認
5. 必要に応じて閾値・パターンを調整

---

## 9. 関連ドキュメント

- 仕様概要: `docs/e-055.md`
- 詳細設計: `docs/e-055-detail.md`
- テスト: `tests/test_e055_extractor.py`, `tests/test_integration_routes.py`
