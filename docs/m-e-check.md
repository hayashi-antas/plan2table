# M-E-Check 機能ドキュメント

**M-E-Check**（Machine-Equipment Check）は、**機器表PDF** と **盤表PDF** の2つをアップロードするだけで、両方の記載が一致しているかを自動で照合する機能です。結果は画面上の表で確認でき、CSV でダウンロードできます。

---

## 何ができるか

| 入力 | 出力 |
|------|------|
| 機器表PDF（換気・空調などの機器一覧） | 判定結果の **一覧表**（HTML） |
| 盤表PDF（電力制御盤の機器一覧） | **unified.csv**（ダウンロード） |

**照合のポイント**: **機器表の情報を正（基準）として**、機器番号ごとに「盤表に記載があるか」「台数が一致するか」「容量(kW)が一致するか」「名称が一致するか」を判定し、**◯ / ✗ / 要確認** を表示します。

---

## 処理の流れ（図）

```
┌─────────────────┐     ┌─────────────────┐
│   機器表PDF      │     │    盤表PDF      │
│ (表形式・ベクトル) │     │ (スキャン画像等)  │
└────────┬────────┘     └────────┬────────┘
         │                       │
         ▼                       ▼
   ┌───────────┐           ┌───────────┐
   │  Vector   │           │  Raster   │
   │  抽出     │           │  (OCR)    │
   │ pdfplumber│           │ Vision API│
   └─────┬─────┘           └─────┬─────┘
         │                       │
         │  vector.csv           │  raster.csv
         │                       │
         └───────────┬───────────┘
                     │
                     ▼
              ┌─────────────┐
              │   Unified   │
              │ 機器番号で結合 │
              │ 一致判定     │
              └──────┬──────┘
                     │
                     ▼
              unified.csv
              （総合判定・台数差・容量差など）
```

**用語の意味**

- **Vector** … 機器表PDFから表構造を読み取って作ったCSV（テキストベース）
- **Raster** … 盤表PDFを画像にしてOCRして作ったCSV（スキャン向け）
- **Unified** … 上記2つを機器番号でつなぎ、◯/✗/要確認 判定を付けた統合CSV

---

## 使い方

1. アプリの **M-E Check** ページ（`/me-check`）を開く
2. **機器表PDF** と **盤表PDF** を選択（ドラッグ＆ドロップまたはファイル選択）
3. **「実行する」** をクリック
4. 処理後、画面上に **判定結果の表** が表示され、**CSVダウンロード** のリンクが表示される

[![Image from Gyazo](https://i.gyazo.com/90ec70f42deef486f8265e8f974222bc.png)](https://gyazo.com/90ec70f42deef486f8265e8f974222bc)

[![Image from Gyazo](https://i.gyazo.com/8479422c23f580227969bdd8c299be14.png)](https://gyazo.com/8479422c23f580227969bdd8c299be14)

[![Image from Gyazo](https://i.gyazo.com/eb2ed7e36991b09e4f6fe5ff1bbba765.png)](https://gyazo.com/eb2ed7e36991b09e4f6fe5ff1bbba765)

[CSVのサンプル](https://github.com/hayashi-antas/m-e-check-data/blob/main/me-check_%E7%85%A7%E5%90%88%E7%B5%90%E6%9E%9C_20260219_0734.csv)

---

## 画面に表示される列

簡易表には次の列が表示されます。

| 列 | 説明 |
|----|------|
| 総合判定 | `◯` / `✗` / `要確認`（内部判定コード `match` / `mismatch` / `review` を表示変換） |
| 判定理由 | 総合判定が `◯` のとき空欄。`✗` / `要確認` のとき主原因を1文で表示（例: `台数差分=1`, `容量が複数候補`, `盤表ID未記載`） |
| 台数判定 / 容量判定 / 名称判定 / 機器ID照合 | 判定表示はすべて `◯` / `✗` / `要確認` に統一（機器ID照合は実質 `◯` / `✗`） |
| 機器ID・機器表 記載名 | 機器番号と機器表に記載された名称 |
| 盤表 記載名 | 盤表側の記載名 |
| 機器表 台数 / 盤表 台数 | それぞれの台数 |
| 台数差・容量差 | 盤表 − 機器表の差分 |
| 盤表 記載トレース | 同一機器IDで盤表の記載（図面番号・名称・容量）が複数パターンあるときに表示。`図面:<番号> 名称:<名称> 容量:<値>` 形式で保持し、複数は ` \| \| ` 連結、同一行の重複は `xN` で件数表示。欠損は `?`。 |
| 機器表 図面番号 | 機器表側の図面番号（同一機器番号で複数ある場合はカンマ併記） |
| 盤表 図面番号 | 盤表側の図面番号（同一機器番号に複数ある場合は `E-024,E-031` のように併記） |

※ 台数差 / 容量差は `盤表 - 機器表`（正: 盤表が大きい、負: 機器表が大きい）。Raster 側の同一機器IDは集約され、図面・名称・容量の組み合わせが複数ある場合は `盤表 記載トレース` で追跡する（Vector 側に同一機器IDが複数行ある場合は、統合結果も複数行になる）。

---

## ダウンロードCSVの列（より詳細）

出力CSVには上記の画面表示列に加え、**容量判定の根拠**を追跡するための列が含まれます（22列）。

| 列 | 説明 |
|----|------|
| （上記の画面列と同一） | 総合判定・判定理由・各判定・機器ID・記載名・台数・台数差・図面番号・盤表 記載トレース など |
| 機器表 消費電力(kW) | 機器表の消費電力（冷/暖/低温など複数モードがある場合は `(冷)9.45 / (暖)7.18` 形式） |
| 機器表 モード容量(kW) | 各モードの容量（例: `冷=9.45,暖=7.18,低温=9.43`） |
| 機器表 判定モード | 容量比較に採用したモード（例: `冷`） |
| 機器表 判定採用容量(kW) | 判定に使った容量の数値 |
| 容量判定補足 | 採用モードの根拠（例: `機器名称ヒント(冷房専用)で(冷)を採用`、`機器名称からモード特定不可のため最大値を採用`） |
| 機器ID照合 | 機器表IDが盤表側にも存在するか（存在: `◯`、不存在: `✗`） |
| 盤表 容量(kW) / 容量差(kW) | 盤表側の容量と、盤表 − 機器表の容量差 |

※ 出力CSVは Excel 互換のため **UTF-8 with BOM (`utf-8-sig`)** で保存する。列の完全な一覧は [m-e-check-detail.md](m-e-check-detail.md) の「6.4 出力列（unified CSV）」を参照。

---

## unified.csv の列がある理由（要点）

`unified.csv` の列は、次の3つの目的で構成されています。

- **判定結果**を返す（総合判定 / 台数判定 / 容量判定 / 名称判定 / 機器ID照合 / 判定理由）
- **比較の根拠**を残す（台数・容量の元値、差分、採用モード）
- **後追い調査できる情報**を残す（図面番号、記載トレース）

特に一見わかりにくい列は、次の意図で存在します。

| 列 | なぜ必要か |
|----|-------------|
| 機器表 モード容量(kW) | `(冷)/(暖)/(低温)` の候補を展開して保存し、「どの候補があったか」を説明できるようにするため。 |
| 機器表 判定モード | 実際に比較に使ったモード（例: `冷`, `最大値(低温)`, `未確定`）を明示し、判定ロジックの追跡性を確保するため。 |
| 機器表 判定採用容量(kW) | 最終比較に使った単一数値を残し、`容量差(kW)` の計算根拠を再現できるようにするため。 |
| 容量判定補足 | なぜそのモードを採用したか（名称ヒント、最大値フォールバック、未確定理由）を文で残し、報告時の説明責任を満たすため。 |
| 機器ID照合 | 機器表IDが盤表側にも存在するかを独立表示し、存在不一致を即時確認できるようにするため。 |
| 盤表 記載トレース | 同一機器ID内の図面・名称・容量の複数パターンを保持し、部分一致による見落としを防ぐため。 |
| 盤表 図面番号 / 機器表 図面番号 | どの図面の記載を比較したかを明示し、差異発生時に原図面へ戻れるようにするため。 |

詳細な列別説明は [m-e-check-detail.md](m-e-check-detail.md) の「6.5 出力列の存在理由（設計意図）」を参照。

---

## 詳細ドキュメント

処理の内部仕様・API・列の対応・開発者向け情報は、次のファイルにまとめています。

**[m-e-check-detail.md](m-e-check-detail.md)** … 用語定義、抽出処理の詳細、Unified の判定ロジック、エンドポイント一覧、環境設定など
