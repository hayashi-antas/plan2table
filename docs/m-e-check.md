# M-E-Check 機能ドキュメント

**M-E-Check**（Machine-Equipment Check）は、**機器表PDF** と **盤表PDF** の2つをアップロードするだけで、両方の記載が一致しているかを自動で照合する機能です。結果は画面上の表で確認でき、CSV でダウンロードできます。

---

## 何ができるか

| 入力 | 出力 |
|------|------|
| 機器表PDF（換気・空調などの機器一覧） | 判定結果の **一覧表**（HTML） |
| 盤表PDF（電力制御盤の機器一覧） | **unified.csv**（ダウンロード） |

**照合のポイント**: **機器表の情報を正（基準）として**、機器番号ごとに「盤表に記載があるか」「台数が一致するか」「容量(kW)が一致するか」「名称が一致するか」を判定し、**◯ / ✗ / 要確認** を表示します。

---

## 処理の流れ（図）

```
┌─────────────────┐     ┌─────────────────┐
│   機器表PDF      │     │    盤表PDF      │
│ (表形式・ベクトル) │     │ (スキャン画像等)  │
└────────┬────────┘     └────────┬────────┘
         │                       │
         ▼                       ▼
   ┌───────────┐           ┌───────────┐
   │  Vector   │           │  Raster   │
   │  抽出     │           │  (OCR)    │
   │ pdfplumber│           │ Vision API│
   └─────┬─────┘           └─────┬─────┘
         │                       │
         │  vector.csv           │  raster.csv
         │                       │
         └───────────┬───────────┘
                     │
                     ▼
              ┌─────────────┐
              │   Unified   │
              │ 機器番号で結合 │
              │ 一致判定     │
              └──────┬──────┘
                     │
                     ▼
              unified.csv
              （総合判定・台数差・容量差など）
```

**用語の意味**

- **Vector** … 機器表PDFから表構造を読み取って作ったCSV（テキストベース）
- **Raster** … 盤表PDFを画像にしてOCRして作ったCSV（スキャン向け）
- **Unified** … 上記2つを機器番号でつなぎ、◯/✗/要確認 判定を付けた統合CSV

---

## 使い方

1. アプリの **M-E Check** ページ（`/me-check`）を開く
2. **機器表PDF** と **盤表PDF** を選択（ドラッグ＆ドロップまたはファイル選択）
3. **「実行する」** をクリック
4. 処理後、画面上に **判定結果の表** が表示され、**CSVダウンロード** のリンクが表示される

[![Image from Gyazo](https://i.gyazo.com/90ec70f42deef486f8265e8f974222bc.png)](https://gyazo.com/90ec70f42deef486f8265e8f974222bc)

[![Image from Gyazo](https://i.gyazo.com/8479422c23f580227969bdd8c299be14.png)](https://gyazo.com/8479422c23f580227969bdd8c299be14)

[![Image from Gyazo](https://i.gyazo.com/eb2ed7e36991b09e4f6fe5ff1bbba765.png)](https://gyazo.com/eb2ed7e36991b09e4f6fe5ff1bbba765)

[CSVのサンプル](https://github.com/hayashi-antas/m-e-check-data/blob/main/me-check_%E7%85%A7%E5%90%88%E7%B5%90%E6%9E%9C_20260219_0734.csv)

---

## 画面に表示される列（CSVも同様）


| 列 | 説明 |
|----|------|
| 総合判定 | `◯` / `✗` / `要確認`（内部判定コード `match` / `mismatch` / `review` を表示変換） |
| 判定理由 | 総合判定が `◯` のとき空欄。`✗` / `要確認` のとき主原因を1文で表示（例: `台数差分=1`, `容量が複数候補`, `盤表ID未記載`） |
| 台数判定 / 容量判定 / 名称判定 | 判定表示はすべて `◯` / `✗` / `要確認` に統一 |
| 機器ID・機器表 記載名 | 機器番号と機器表に記載された名称 |
| 盤表 記載名 | 盤表側の記載名 |
| 機器表 台数 / 盤表 台数 | それぞれの台数 |
| 台数差・容量差 | 盤表 − 機器表の差分 |
| 盤表 記載トレース | 例外時のみ表示。盤表の行単位記載を `図面:<番号> 名称:<名称> 容量:<値>` 形式で保持。複数は ` || ` 連結、同一行の重複は `xN` で件数表示。欠損は `?`。 |
| 機器表 図面番号 | 機器表側の図面番号（同一機器番号で複数ある場合はカンマ併記） |
| 盤表 図面番号 | 盤表側の図面番号（同一機器番号に複数ある場合は `E-024,E-031` のように併記） |

※ 台数差 / 容量差は `盤表 - 機器表`（正: 盤表が大きい、負: 機器表が大きい）。
※ 同一機器IDは1行のまま維持し、図面ごとの記載差分がある場合だけ `盤表 記載トレース` で追跡する。
※ 出力CSVは Excel 互換のため **UTF-8 with BOM (`utf-8-sig`)** で保存する。

---

## 詳細ドキュメント

処理の内部仕様・API・列の対応・開発者向け情報は、次のファイルにまとめています。

**[m-e-check-detail.md](m-e-check-detail.md)** … 用語定義、抽出処理の詳細、Unified の判定ロジック、エンドポイント一覧、環境設定など
