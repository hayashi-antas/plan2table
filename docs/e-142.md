# E-142 大枠1行抽出 機能ドキュメント

**E-142 OCR** は、E-142系の姿図PDFから「大枠」単位で情報を抽出し、
1枠=1行のヘッダーなしCSVを出力する機能です。

## 何ができるか

- 入力: E-142系PDF（複数ページ対応）
- 出力: 枠ごとのフラット行
  - `タイトル,番号,表ラベル,値,...`
- CSV: `e142.csv`（UTF-8 with BOM、ヘッダーなし、可変列）

## API

- `GET /e-142`: E-142抽出画面
- `POST /e-142/upload`: PDFアップロードして抽出
- `GET /jobs/{job_id}/e142.csv`: 結果CSVをダウンロード

## 抽出ルール

1. PDFを画像化し、OCRで文字を読み取ります。
2. OCRで得た文字を、まずY方向で「行」ごとにまとめ、次にX方向の間隔で行内をセグメント分割します。
3. まず、`電源電圧/入力電圧/出力電圧/出力電流/消費電流/消費電力/質量/材質/形状/色調/塗色/塗装/備考` のラベル語を含むセグメントを、表データ候補として扱います。
4. ラベル語の候補が取れない場合は、左列（項目名）と右列（値）の位置関係（同じ行で右側に値がある並び）から表行を推定するフォールバックを使います。
5. 各表ブロックの直上にある文字から、タイトル候補（日本語主体かつ表ラベル語を含まない）を選びます。
6. タイトルの直下にある候補から、番号として使う識別子を優先順で1つ選びます（型番、商品コード、`特注品`）。
7. 表の内容を `ラベル,値` ペアに正規化し、OCRで発生しやすい表記ゆれ（例: `9q -> 9g`）を補正したうえで1行にフラット化します。
8. 最終出力は「1大枠=1行」です。表がなければ `タイトル,番号`、番号もなければ `タイトル` のみを出力します。

## 実装ファイル

- ルーティング: `main.py`
- 抽出ロジック: `extractors/e142_extractor.py`
- ジョブCSV種別: `extractors/job_store.py`
- UIテンプレート: `templates/e-142.html`
- テスト: `tests/test_e142_extractor.py`, `tests/test_integration_routes.py`, `tests/test_job_store.py`

## 関連ドキュメント

- 詳細設計（開発者向け）: `docs/e142-detail.md`
- FAQ（実装準拠）: `docs/e142-faq.md`

## 必須設定

- `VISION_SERVICE_ACCOUNT_KEY`

未設定時、`/e-142/upload` はエラーを返します。
