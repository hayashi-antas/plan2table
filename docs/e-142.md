# E-142 大枠1行抽出 機能ドキュメント

**E-142 OCR** は、E-142系の姿図PDFから「大枠」単位で情報を抽出し、
1枠=1行のヘッダーなしCSVを出力する機能です。

## 何ができるか

- 入力: E-142系PDF（複数ページ対応）
- 出力: 枠ごとのフラット行
  - `タイトル,番号,表ラベル,値,...`
- CSV: `e142.csv`（UTF-8 with BOM、ヘッダーなし、可変列）

## API

- `GET /e-142`: E-142抽出画面
- `POST /e-142/upload`: PDFアップロードして抽出
- `GET /jobs/{job_id}/e142.csv`: 結果CSVをダウンロード

## 抽出ルール

1. OCRは Vision API + `pdftoppm` で全ページ解析します（`page=0`）。
2. OCR単語をYクラスタ化し、Xギャップで行内セグメント分割します。
3. `電源電圧/消費電流/消費電力/入力電圧/出力電圧/質量/材質/形状/色調/塗色/備考` を含むセグメントを表候補とします。
4. 表候補を `x重なり + y近接` でクラスタし、大枠ごとの表ブロックにまとめます。
5. 各表ブロックの直上からタイトル候補（日本語主体、表ラベル語を含まない）を採用します。
6. タイトル直下から `^[A-Z]{1,4}-[A-Z0-9]{2,}` に一致する番号候補を採用します。
7. 表行はラベル値ペアに正規化し、1行へフラット化します。
8. 表がなければ `タイトル,番号`、番号もなければ `タイトル` のみを出力します。

## 実装ファイル

- ルーティング: `main.py`
- 抽出ロジック: `extractors/e142_extractor.py`
- ジョブCSV種別: `extractors/job_store.py`
- UIテンプレート: `templates/e-142.html`
- テスト: `tests/test_e142_extractor.py`, `tests/test_integration_routes.py`, `tests/test_job_store.py`

## 関連ドキュメント

- 詳細設計（開発者向け）: `docs/e142-detail.md`
- FAQ（実装準拠）: `docs/e142-faq.md`

## 必須設定

- `VISION_SERVICE_ACCOUNT_KEY`

未設定時、`/e-142/upload` はエラーを返します。
