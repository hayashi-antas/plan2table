# E-055 相当型番抽出 機能ドキュメント

**E-055 OCR** は、照明器具姿図のPDFから **器具記号** と **相当型番** を読み取り、  
`機器器具 / メーカー / 型番` の3列CSVとして出力する機能です。

---

## 何ができるか

| 入力 | 出力 |
|------|------|
| 照明器具姿図PDF（例: E-055） | 3列テーブル（HTML） |
| 同上 | `e055.csv`（ダウンロード） |

---

## 使い方

1. ポータル（`/`）から **相当型番抽出（E-055 OCR）** を開く  
2. `PDF` を1ファイルアップロード
3. **抽出を開始する** をクリック
4. 画面上の結果表と `CSV` ダウンロードを確認

ページURL: `GET /e-055`

[![Image from Gyazo](https://i.gyazo.com/c91280cdc4b60f3bd89509e9e5f7d21b.png)](https://gyazo.com/c91280cdc4b60f3bd89509e9e5f7d21b)
---

## 出力列

固定で次の3列を出力します。

1. `機器器具`
2. `メーカー`
3. `型番`

CSV文字コードは `UTF-8 with BOM (utf-8-sig)` です。

---

## 抽出ルール

### 1. 相当型番の分解

- `メーカー:型番`（半角/全角コロン）を分解して出力  
- コロンがない場合は `メーカー=""`、`型番=元文字列`

### 2. `×N` の保持

- `×2`, `x3`, `✕4`, `(x2)` などの乗数表記は **型番列にそのまま保持**  
- 例: `TAD-ELT7W1-146J27-24A x6` → `TAD-ELT7W1-146J27-24A x6`
- OCRの分割次第で `×1` と `× 1` の両方があり得ます（`×\s*\d+` 相当を保持）。

### 3. 非常灯評定番号行の除外

- 次のいずれかを満たす行は最終CSVに出力しません（OR条件）。
- `機器器具` が `EDL / EDM / ECL / ECM / ECH / ES1 / ES2`
- `型番` が `LALE-...`（非常灯評定番号）

### 4. 同上行の扱い

- `同上` を含む行は抽出対象
- `同上 + ガード系語`（例: `ガード`, `犬-F`, `一卡付` などOCR揺れ含む）  
  → `型番="同上ガード付"`
- それ以外の同上は `型番="同上"`
- 同上行は `メーカー=""`

### 5. 継続行（器具記号空欄行）の扱い

TP系のように、次行に型番が続くケースも抽出します。

- 例: `TP1` 行の次行に `TAD-ELT7W1-122J27-24A×1` がある場合  
  → `機器器具=TP1`, `メーカー=""`, `型番=TAD-ELT7W1-122J27-24A×1`
- 例: `DL9` 行の次行に `DAIKO:LZA-93039` がある場合  
  → `機器器具=DL9`, `メーカー=DAIKO`, `型番=LZA-93039`
- 同一ブロック内の直前器具記号を引き継いで割り当てます。

### 6. 型番空行の除外

- `型番` が空の行は最終CSVに出力しません（`メーカー:` のみで型番実体がない行を含む）。

### 7. 並び順（自然順）

CSVは次の順で並びます。

`page -> section(ヘッダ帯) -> block(左→右) -> row(上→下)`

このため、同一ブロック内の行（例: `CT1 -> CT1g -> CT2 -> CT2g`）が連続して出力されます。

---

## API

| Method | Path | 説明 |
|---|---|---|
| `GET` | `/e-055` | E-055抽出画面 |
| `POST` | `/e-055/upload` | PDFを受け取り抽出してHTMLを返す |
| `GET` | `/jobs/{job_id}/e055.csv` | 実行結果のCSVをダウンロード |

---

## 実装ファイル

- ルーティング: `main.py`
- 抽出ロジック: `extractors/e055_extractor.py`
- ジョブCSV種別: `extractors/job_store.py`
- UIテンプレート: `templates/e-055.html`
- テスト: `tests/test_e055_extractor.py`, `tests/test_integration_routes.py`

---

## 必要な設定

- `VISION_SERVICE_ACCOUNT_KEY`（Google Vision APIサービスアカウントJSON）

未設定時は `/e-055/upload` がエラーを返します。

### 本番差分切り分け用（任意）

- `E055_DEBUG_DIAGNOSTICS=1` を設定すると、E-055実行時に以下を出力します。
- サーバーログ: `git sha` / `pdftoppm -v` / 診断ファイル保存先
- 診断JSON: `/tmp/plan2table/debug/<job_id>/e055_diagnostics.json`
- 診断JSONには、TP/CT/DL/同上などのフォーカス行OCRトークン（bbox付き）と候補行マッピングを含みます。
- フォーカス語は `E055_DEBUG_FOCUS_TERMS`（カンマ区切り）で上書きできます。  
  例: `E055_DEBUG_FOCUS_TERMS=TP1,TP2,CT2G,DL9,同上`

### 線認識サブ信号（任意・既定auto）

E-055 では既存OCR座標ロジックに加えて、低信頼ケースのみ線認識を補助信号として使えます。  
既定は `auto`（低信頼時のみ実行）で、通常ケースの性能影響を抑えます。

- `E055_LINE_ASSIST_MODE=auto|off|force`
  - `auto`（既定）: 低信頼時のみ線認識を実行
  - `off`: 線認識を無効化
  - `force`: 低信頼判定を無視して線認識を毎回試行
- `E055_LINE_ASSIST_LATENCY_BUDGET_MS`（既定 `300`）  
  線認識サブ処理の時間予算（ms）
- `E055_LINE_ASSIST_MIN_CONFIDENCE`（既定 `0.70`）  
  線認識の結果を採用する最小信頼度
- `E055_LINE_ASSIST_DEBUG=1`  
  診断JSONに線認識の判断情報（invoked/adopted/confidence/elapsed）を追加

### 実測メモ（2026-02-25）

実データ `E-055.pdf` で `auto` と `force` を比較した結果:

- `auto`: 30行抽出、線認識 `invoked=0` / `adopted=0`
- `force`: 30行抽出、線認識 `invoked=5` / `adopted=0`（`rejected_reason=no_quality_gain`）
- `auto` と `force` のCSVは完全一致

運用判断:

- 既定は `auto` 維持（通常ケースは追加コストなし）
- 線認識は「難ケース発生時の保険」として機能を残す

---

## 注意点

- OCR特性上、図面品質や文字の潰れにより誤読が発生する場合があります。
- 本機能は重複行を削除しません（読み取った順に保持します）。
- 複数ページPDFは全ページを対象に処理します。
