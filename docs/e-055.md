# E-055 相当型番抽出 機能ドキュメント

**E-055 OCR** は、照明器具姿図のPDFから **器具記号** と **相当型番** を読み取り、  
`機器器具 / メーカー / 型番` の3列CSVとして出力する機能です。

---

## 何ができるか

| 入力 | 出力 |
|------|------|
| 照明器具姿図PDF（例: E-055） | 3列テーブル（HTML） |
| 同上 | `e055.csv`（ダウンロード） |

---

## 使い方

1. ポータル（`/`）から **相当型番抽出（E-055 OCR）** を開く  
2. `PDF` を1ファイルアップロード
3. **抽出を開始する** をクリック
4. 画面上の結果表と `CSV` ダウンロードを確認

ページURL: `GET /e-055`

---

## 出力列

固定で次の3列を出力します。

1. `機器器具`
2. `メーカー`
3. `型番`

CSV文字コードは `UTF-8 with BOM (utf-8-sig)` です。

---

## 抽出ルール

### 1. 相当型番の分解

- `メーカー:型番`（半角/全角コロン）を分解して出力  
- コロンがない場合は `メーカー=""`、`型番=元文字列`

### 2. `×N` の除去

- `×2`, `x3` などの乗数表記は **型番列のみ** から除去  
- 例: `TAD-ELT7W1-146J27-24Ax6` → `TAD-ELT7W1-146J27-24A`

### 3. 同上行の扱い

- `同上` を含む行は抽出対象
- `同上 + ガード系語`（例: `ガード`, `犬-F`, `一卡付` などOCR揺れ含む）  
  → `型番="同上ガード付"`
- それ以外の同上は `型番="同上"`
- 同上行は `メーカー=""`

### 4. 継続行（器具記号空欄行）の扱い

TP系のように、次行に型番が続くケースも抽出します。

- 例: `TP1` 行の次行に `TAD-ELT7W1-122J27-24A×1` がある場合  
  → `機器器具=TP1`, `メーカー=""`, `型番=TAD-ELT7W1-122J27-24A`
- 同一ブロック内の直前器具記号を引き継いで割り当てます。

### 5. 並び順（自然順）

CSVは次の順で並びます。

`page -> section(ヘッダ帯) -> block(左→右) -> row(上→下)`

このため、同一ブロック内の行（例: `CT1 -> CT1g -> CT2 -> CT2g`）が連続して出力されます。

---

## API

| Method | Path | 説明 |
|---|---|---|
| `GET` | `/e-055` | E-055抽出画面 |
| `POST` | `/e-055/upload` | PDFを受け取り抽出してHTMLを返す |
| `GET` | `/jobs/{job_id}/e055.csv` | 実行結果のCSVをダウンロード |

---

## 実装ファイル

- ルーティング: `main.py`
- 抽出ロジック: `extractors/e055_extractor.py`
- ジョブCSV種別: `extractors/job_store.py`
- UIテンプレート: `templates/e-055.html`
- テスト: `tests/test_e055_extractor.py`, `tests/test_integration_routes.py`

---

## 必要な設定

- `VISION_SERVICE_ACCOUNT_KEY`（Google Vision APIサービスアカウントJSON）

未設定時は `/e-055/upload` がエラーを返します。

---

## 注意点

- OCR特性上、図面品質や文字の潰れにより誤読が発生する場合があります。
- 本機能は重複行を削除しません（読み取った順に保持します）。
- 複数ページPDFは全ページを対象に処理します。
